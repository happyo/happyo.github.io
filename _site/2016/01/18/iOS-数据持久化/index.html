<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
      <title>hikari - Fluid, responsive blog theme for Jekyll</title>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta http-equiv="content-language" content="en-gb" />
      <meta name="description" content="Fluid, responsive blog theme for Jekyll">
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,700|Lora:400,700,400italic" rel="stylesheet" type="text/css">
      <link rel="stylesheet" type="text/css" href="/hikari-for-jekyll/css/main.css" />
      <link href="atom.xml" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
  </head>

  <body>
    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <div class="off-canvas">
      <figure class="avatar">
        <img src="/hikari-for-jekyll/assets/img/avatar.jpg" alt="Picture" title="That's me, John Doge.">
      </figure>
      <div class="bio">
          <h1>Hi, I'm John Doge.</h1>
          <p>I'm a dog. I develop things. This is my blog so why don't you close this damn side panel (cursed by most UX Designers but I don't care, I do whatever I want) and start reading my awesome stuff?</p>
      </div>
      <nav>
        <h6>Follow me on</h6>
        <ul>
          
          <li><a target="_blank" href="https://twitter.com/mx3m">Twitter</a></li>
          
          
          <li><a target="_blank" href="https://github.com/m3xm">Github</a></li>
          
          
          <li><a target="_blank" href="https://dribbble.com/m3xm">Dribbble</a></li>
          
          
          <li><a target="_blank" href="https://instagram.com/m3xm">Instagram</a></li>
          
        </ul>
      </nav>
    </div>


    <div class="site-wrapper">

      <header>
        <div class="h-wrap">
          <h1 class="title"><a href="/hikari-for-jekyll/" title="Back to Homepage">hikari</a></h1>
          <a class="menu-icon" title="Open Bio"><span class="lines"></span></a>
        </div>
      </header>

      <main>
        <section class="single-wrap">
  <article class="single-content" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="feat">
      <h5 class="page-date">
        <time datetime="2016-01-18T16:10:54+08:00" itemprop="datePublished">
          18 January 2016
        </time>
      </h5>
    </div>
    <h1 class="page-title" itemprop="name headline">iOS 数据持久化</h1>
    <div itemprop="articleBody">
      <blockquote>
  <p>数据持久化即数据的永久存储。在 iOS 中，是将数据保存成文件，存储到程序的沙盒中。</p>
</blockquote>

<h1 id="沙盒">沙盒</h1>
<hr />
<ul>
  <li>每个 iOS 应用都有自己的应用沙盒，应用沙盒就是文件系统目录，与其他应用放入文件 系统隔离，iOS 系统不允许访问其他应用的应用沙盒，但在 ios8 中已经开放访问（extension）</li>
  <li>extension 是 iOS8 新开放的一种对几个固定系统区域的拓展机制，它可以在一定程度上弥补 iOS 的沙盒机制对应用间的通信限制</li>
  <li>应用沙盒一般包括以下几个文件目录:</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="p">.</span><span class="n">app</span>
<span class="n">Documents</span>
<span class="n">Library</span>  
<span class="o">---</span><span class="n">Caches</span>
<span class="o">---</span><span class="n">Preferences</span>
<span class="n">tmp</span></code></pre></figure>

<h1 id="目录简介及获取">目录简介及获取</h1>
<hr />
<ul>
  <li><strong>沙盒根目录获取</strong>: 获取如下</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSString</span> <span class="o">*</span><span class="n">homePath</span> <span class="o">=</span> <span class="n">NSHomeDirectory</span><span class="p">();</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">homePath</span><span class="p">);</span></code></pre></figure>

<ul>
  <li><strong>.app文件</strong>: 这里面存放的是应用程序的源文件，包括资源文件和可执行文件。</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSString</span> <span class="o">*</span><span class="n">appPath</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">bundlePath</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">appPath</span><span class="p">);</span></code></pre></figure>

<ul>
  <li><strong>Documents</strong>: 保存应用运行时生成的需要持久化的数据，<code>iTunes</code> 会自动备份该目录。</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSString</span> <span class="o">*</span><span class="n">documentPath</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">).</span><span class="n">firstObject</span><span class="p">;</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">documentPath</span><span class="p">);</span></code></pre></figure>

<ul>
  <li><strong>tmp</strong>: 保存应用运行时所需的临时数据，使用完毕后再将对应的文件从该目录删除，应用没有运行时，系统也可能会自动清理该目录下的文件，<code>iTunes</code> 不会同步该目录，iPhone 重启时该目录下的文件会丢失。</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSString</span> <span class="o">*</span><span class="n">tmpPath</span> <span class="o">=</span> <span class="n">NSTemporaryDirectory</span><span class="p">();</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">tmpPath</span><span class="p">);</span></code></pre></figure>

<ul>
  <li><strong>Library</strong>: 存储程序的默认设置和其他状态信息，<code>iTunes </code>会自动备份该目录。</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSString</span> <span class="o">*</span><span class="n">libraryPath</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSLibraryDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">).</span><span class="n">firstObject</span><span class="p">;</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">libraryPath</span><span class="p">);</span></code></pre></figure>

<ul>
  <li><strong>Library/Caches</strong>: 存放缓存文件，<code>iTunes</code>不会备份此目录，此目录下文件不会在应用退出时删除，一般存放体积比较大，不是很重要的资源</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSString</span> <span class="o">*</span><span class="n">cachesPath</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSCachesDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">).</span><span class="n">firstObject</span><span class="p">;</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">cachesPath</span><span class="p">);</span></code></pre></figure>

<ul>
  <li><strong>Library/Preferences</strong>: 保存应用的所有偏好设置，iOS 的 <code>Setting（设置）</code>会在该目录中查找应用的设置信息，iTunes会自动备份该目录。</li>
</ul>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSString</span> <span class="o">*</span><span class="n">preferencesPath</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSLibraryDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">).</span><span class="n">firstObject</span><span class="p">;</span>
<span class="n">preferencesPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">preferencesPath</span> <span class="nl">stringByAppendingPathComponent</span><span class="p">:</span><span class="s">@&quot;Preferences&quot;</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">preferencesPath</span><span class="p">);</span></code></pre></figure>

<h1 id="ios的数据持久化方式一般有以下5种">iOS的数据持久化方式一般有以下5种</h1>
<hr />
<ol>
  <li>plist（属性列表）</li>
  <li>preferences (NSUserDefaults)</li>
  <li>NSKeyedArchiver (归档)</li>
  <li>SQLite 3</li>
  <li>CoreData</li>
</ol>

<h2 id="plist属性列表">plist（属性列表）</h2>

<p>属性列表文件是一种 <code>XML</code> 文件，<code>Foundation</code> 框架中的一些对象可以与属性列表文件互相转换，可转换的类型如下：</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="bp">NSArray</span><span class="p">;</span>
<span class="bp">NSMutableArray</span><span class="p">;</span>
<span class="bp">NSDictionary</span><span class="p">;</span>
<span class="bp">NSMutableDictionary</span><span class="p">;</span>
<span class="bp">NSData</span><span class="p">;</span>
<span class="bp">NSMutableData</span><span class="p">;</span>
<span class="bp">NSString</span><span class="p">;</span>
<span class="bp">NSMutableString</span><span class="p">;</span>
<span class="bp">NSNumber</span><span class="p">;</span></code></pre></figure>

<h3 id="存储和使用">存储和使用</h3>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="c1">// 获取存储文件的路径</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">documentPath</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">).</span><span class="n">firstObject</span><span class="p">;</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">fileName</span> <span class="o">=</span> <span class="p">[</span><span class="n">documentPath</span> <span class="nl">stringByAppendingPathComponent</span><span class="p">:</span><span class="s">@&quot;storage.plist&quot;</span><span class="p">];</span>

<span class="c1">// 存储</span>
<span class="bp">NSArray</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="l">@[</span><span class="s">@&quot;hello&quot;</span><span class="p">,</span> <span class="s">@&quot;world&quot;</span><span class="l">]</span><span class="p">;</span>
<span class="p">[</span><span class="n">array</span> <span class="nl">writeToFile</span><span class="p">:</span><span class="n">fileName</span> <span class="nl">atomically</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>

<span class="c1">// 读取</span>
<span class="bp">NSArray</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSArray</span> <span class="nl">arrayWithContentsOfFile</span><span class="p">:</span><span class="n">fileName</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;result :%@&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

<span class="c1">// 当存入的数组含有 null 的时候写文件会失败</span>
<span class="bp">NSArray</span> <span class="o">*</span><span class="n">modifyArray</span> <span class="o">=</span> <span class="l">@[</span><span class="s">@&quot;hello&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSNull</span> <span class="n">null</span><span class="p">]</span><span class="l">]</span><span class="p">;</span>
<span class="p">[</span><span class="n">modifyArray</span> <span class="nl">writeToFile</span><span class="p">:</span><span class="n">fileName</span> <span class="nl">atomically</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>

<span class="c1">// 结果发现取出来的还是第一次存的数组</span>
<span class="bp">NSArray</span> <span class="o">*</span><span class="n">modifyResult</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSArray</span> <span class="nl">arrayWithContentsOfFile</span><span class="p">:</span><span class="n">fileName</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;modify result :%@&quot;</span><span class="p">,</span> <span class="n">modifyResult</span><span class="p">);</span></code></pre></figure>

<h3 id="运行结果">运行结果</h3>
<p><img src="http://cl.ly/241B0p0t0g0o/Image%202016-01-18%20at%207.50.49%20%E4%B8%8B%E5%8D%88.png" alt="plistResult" /></p>

<h3 id="注意">注意</h3>
<ul>
  <li>只有上面提到的特定类型才能用 plist 进行存储</li>
  <li><code>writeToFile: atomically:</code> 的<code>atom</code></li>
  <li>当需要存的对象里面包含<code>NULL</code>时，存文件会失败。（很多情况下是服务端返回的数据包含 <code>null</code>，然后转化成对象存会失败）</li>
</ul>

<hr />

<h2 id="preferences-nsuserdefaults">preferences (NSUserDefaults)</h2>
<p><code>NSUserDefaults</code>是一个单例，在整个程序中只有一个实例对象，他可以用于数据的永久保存，而且简单实用。</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="c1">// 获取 NSUserDefaults 的单例对象</span>
<span class="bp">NSUserDefaults</span> <span class="o">*</span><span class="n">userDefaults</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>

<span class="c1">// 存储</span>
<span class="p">[</span><span class="n">userDefaults</span> <span class="nl">setObject</span><span class="p">:</span><span class="s">@&quot;happyo&quot;</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
<span class="p">[</span><span class="n">userDefaults</span> <span class="nl">setBool</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;isMale&quot;</span><span class="p">];</span>
<span class="p">[</span><span class="n">userDefaults</span> <span class="nl">setInteger</span><span class="p">:</span><span class="mi">25</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;age&quot;</span><span class="p">];</span>

<span class="c1">// 立即同步</span>
<span class="p">[</span><span class="n">userDefaults</span> <span class="n">synchronize</span><span class="p">];</span>

<span class="c1">// 读取</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">nameStr</span> <span class="o">=</span> <span class="p">[</span><span class="n">userDefaults</span> <span class="nl">objectForKey</span><span class="p">:</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
<span class="kt">BOOL</span> <span class="n">isMale</span> <span class="o">=</span> <span class="p">[</span><span class="n">userDefaults</span> <span class="nl">boolForKey</span><span class="p">:</span><span class="s">@&quot;isMale&quot;</span><span class="p">];</span>
<span class="n">NSInteger</span> <span class="n">age</span> <span class="o">=</span> <span class="p">[</span><span class="n">userDefaults</span> <span class="nl">integerForKey</span><span class="p">:</span><span class="s">@&quot;age&quot;</span><span class="p">];</span>

<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;name : %@, isMale :%d, age :%ld&quot;</span><span class="p">,</span> <span class="n">nameStr</span><span class="p">,</span> <span class="n">isMale</span><span class="p">,</span> <span class="n">age</span><span class="p">);</span></code></pre></figure>

<h3 id="结果如下">结果如下</h3>

<p><img src="http://cl.ly/273C1L3t020W/Image%202016-01-18%20at%209.18.02%20%E4%B8%8B%E5%8D%88.png" alt="preferencesResult" /></p>

<h3 id="注意-1">注意</h3>

<ul>
  <li>偏好设置是专门用来保存应用程序的配置信息的，一般不要在偏好设置中保存其他数据。</li>
  <li>如果没有调用<code>synchronize</code>方法，系统会根据 I/O 情况不定时刻地保存到文件中。所以如果需要立即写入文件的就必须调用<code>synchronize</code>方法。</li>
  <li>偏好设置会将所有数据保存到同一个文件中。即 <code>preference</code> 目录下的一个以此应用包名来命名的 plist 文件。</li>
</ul>

<h2 id="nskeyedarchiver-归档">NSKeyedArchiver (归档)</h2>
<p>对象归档是一种序列化方式。为了便于数据传输，先将归档序列化成一个文件，然后通过返归档将数据恢复到对象中。
对一个对象进行完整归档需要满足的条件为：该对象的类必须实现<code>NSCoding</code>协议，而且每个成员变量应该是基本数据类型或者都是实现了<code>NSCoding</code>协议的某个类的实例。</p>

<p>创建一个<code>Car</code>类，使其实现<code>NSCoding</code>协议</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="k">@interface</span> <span class="nc">Car</span> : <span class="bp">NSObject</span> <span class="o">&lt;</span><span class="bp">NSCoding</span><span class="o">&gt;</span>

<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">copy</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">)</span> <span class="n">NSInteger</span> <span class="n">speed</span><span class="p">;</span>

<span class="k">@end</span>


<span class="k">@implementation</span> <span class="nc">Car</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">encodeWithCoder:</span><span class="p">(</span><span class="bp">NSCoder</span> <span class="o">*</span><span class="p">)</span><span class="nv">aCoder</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">aCoder</span> <span class="nl">encodeObject</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">name</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
    <span class="p">[</span><span class="n">aCoder</span> <span class="nl">encodeInteger</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">speed</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;speed&quot;</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithCoder:</span><span class="p">(</span><span class="bp">NSCoder</span> <span class="o">*</span><span class="p">)</span><span class="nv">aDecoder</span>
<span class="p">{</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">aDecoder</span> <span class="nl">decodeObjectForKey</span><span class="p">:</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">[</span><span class="n">aDecoder</span> <span class="nl">decodeIntegerForKey</span><span class="p">:</span><span class="s">@&quot;speed&quot;</span><span class="p">];</span>

    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span></code></pre></figure>

<p>对其进行归档和解档</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="c1">// 创建对象</span>
<span class="n">Car</span> <span class="o">*</span><span class="n">car</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Car</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
<span class="n">car</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@&quot;Aventador&quot;</span><span class="p">;</span>
<span class="n">car</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>

<span class="c1">// 获得存储路径</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">documentPath</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">).</span><span class="n">firstObject</span><span class="p">;</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">fileName</span> <span class="o">=</span> <span class="p">[</span><span class="n">documentPath</span> <span class="nl">stringByAppendingString</span><span class="p">:</span><span class="s">@&quot;car.data&quot;</span><span class="p">];</span>

<span class="c1">// 归档</span>
<span class="p">[</span><span class="bp">NSKeyedArchiver</span> <span class="nl">archiveRootObject</span><span class="p">:</span><span class="n">car</span> <span class="nl">toFile</span><span class="p">:</span><span class="n">fileName</span><span class="p">];</span>

<span class="c1">// 解档</span>
<span class="n">Car</span> <span class="o">*</span><span class="n">unarchiveCar</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSKeyedUnarchiver</span> <span class="nl">unarchiveObjectWithFile</span><span class="p">:</span><span class="n">fileName</span><span class="p">];</span>

<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;car :%@ , speed :%ld&quot;</span><span class="p">,</span> <span class="n">unarchiveCar</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">unarchiveCar</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span></code></pre></figure>

<h3 id="注意-2">注意</h3>
<ul>
  <li>对象必须实现<code>NSCoding</code>协议</li>
  <li>保存文件的扩展名可以任意指定</li>
  <li>有继承关系时，要先调用父类的归解档方法</li>
</ul>

<h2 id="sqlite-3">SQLite 3</h2>
<p><code>SQLite</code>是无数据类型的数据库，就是字段不用指定类型。虽然<code>SQLite</code>可以忽略数据类型，但从编程的规范上讲，应该在<code>Create Table</code>语句中指定数据类型。因为数据类型可以告知这个字段的含义，便于别人阅读和理解。<code>SQLite</code>支持的常见数据类型如下：</p>

<ul>
  <li><strong>INTEGER</strong>: 有符号的整数类型</li>
  <li><strong>REAL</strong>: 浮点类型</li>
  <li><strong>TEXT</strong>: 字符串类型，采用UTF-8和UTF-16字符编码</li>
  <li><strong>BLOB</strong>: 二进制大对象类型，能够存放任何二进制数据</li>
</ul>

<h3 id="首先添加类库">首先添加类库</h3>
<p><img src="http://cl.ly/3D1M0P373W38/Image%202016-01-19%20at%2010.52.22%20%E4%B8%8A%E5%8D%88.png" alt="addLibrary" /></p>

<p>然后导入头文件</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="cp">#import &lt;sqlite3.h&gt;</span></code></pre></figure>

<p>在使用<code>SQLite</code>之前，我们先熟悉下它提供的一些方法</p>

<ul>
  <li><strong>sqlite3_open</strong>: 这个方法用于创建并且打开一个数据库文件。它提供了两个参数，第一个是数据库文件名，第二个是数据库句柄。如果文件不存在的话，他会先创建然后再打开，否则直接打开。</li>
  <li><strong>sqlite_prepare_v2</strong>: 这个方法的作用是，获得一个 string 类型的 SQL语句（查询语句），然后将其转化成可执行的语句。即检查 SQL语句的合法性。</li>
  <li><strong>sqlite_step</strong>: 在这个方法之前一般要执行预处理操作。当有数据返回时，它就会被调用。注意，不能在<code>sqlite_prepare_v2</code>之前调用它。</li>
  <li><strong>sqlite_finalize</strong>: 将预处理的语句删除掉</li>
  <li><strong>sqlite_column_count</strong>: 返回表里一共有多少列。</li>
  <li><strong>sqlite_column_text</strong>: 将指定的列数据变成<code>TEXT</code>类型返回。</li>
  <li><strong>sqlite_column_name</strong>: 返回列的名称</li>
  <li><strong>sqlite_exec</strong>: 它是对<code>[sqlite3_prepare_v2()]</code>, <code>[sqlite3_step()]</code>, 和 <code>[sqlite3_finalize()]</code>的一个封装，使我们执行 SQL的时候不用写太多的 c 代码。这个可以执行任意 SQL，例如插入，更新，删除，但一般查询的时候还是使用前3个方法。</li>
  <li><strong>sqlite_errmsg</strong>: 返回 SQLite 的错误描述</li>
  <li><strong>sqlite_close</strong>: 关闭数据库连接</li>
</ul>

<h3 id="创建表">创建表</h3>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="c1">// 获取文件路径名</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">fileName</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">).</span><span class="n">firstObject</span> <span class="nl">stringByAppendingString</span><span class="p">:</span><span class="s">@&quot;person.sqlite&quot;</span><span class="p">];</span>

<span class="c1">// 打开数据库</span>
<span class="n">NSInteger</span> <span class="n">openResult</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">fileName</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myDb</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">openResult</span> <span class="o">==</span> <span class="n">SQLITE_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;打开数据库成功&quot;</span><span class="p">);</span>

    <span class="c1">// 创建表 SQL</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">sqlCreateTable</span> <span class="o">=</span> <span class="s">@&quot;CREATE TABLE IF NOT EXISTS person_info (ID INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, age INTEGER)&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">errmsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// 执行语句</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">myDb</span><span class="p">,</span> <span class="n">sqlCreateTable</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">errmsg</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">errmsg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;建表失败： %s&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;建表成功&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;打开数据库失败&quot;</span><span class="p">);</span>
    <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">myDb</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h3 id="插入数据">插入数据</h3>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="c1">// 插入10条数据</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">nameStr</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;happyo%i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">];</span>
    <span class="n">NSInteger</span> <span class="n">age</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">sqlInsertData</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;INSERT INTO person_info (name, age) VALUES (&#39;%@&#39;, &#39;%ld&#39;)&quot;</span><span class="p">,</span><span class="n">nameStr</span> <span class="p">,</span> <span class="n">age</span><span class="p">];</span>

    <span class="c1">// 执行语句</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">myDb</span><span class="p">,</span> <span class="n">sqlInsertData</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">errmsg</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">errmsg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;插入失败： %s&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;插入成功&quot;</span><span class="p">);</span></code></pre></figure>

<h3 id="查询">查询</h3>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span></span><span class="c1">// 查询数据</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">sqlQuery</span> <span class="o">=</span> <span class="s">@&quot;SELECT name, age FROM person_info&quot;</span><span class="p">;</span>
<span class="n">sqlite3_stmt</span> <span class="o">*</span><span class="n">stmt</span><span class="p">;</span>

<span class="n">NSInteger</span> <span class="n">queryResult</span> <span class="o">=</span> <span class="n">sqlite3_prepare_v2</span><span class="p">(</span><span class="n">myDb</span><span class="p">,</span> <span class="n">sqlQuery</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stmt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">queryResult</span> <span class="o">==</span> <span class="n">SQLITE_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">sqlite3_step</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span> <span class="o">==</span> <span class="n">SQLITE_ROW</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">NSInteger</span> <span class="n">age</span> <span class="o">=</span> <span class="n">sqlite3_column_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;name :%s , age :%ld&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span></code></pre></figure>

<p>由于原生的 SQLite 方法都是 c 写的，比较难用。所以一般在开发过程中，我们都使用第三方开源库 <code>FMDB</code> 。关于<code>FMDB</code>，<a href="http://blog.devtang.com/blog/2012/04/22/use-fmdb/">这里</a>有介绍使用的。</p>

<h2 id="coredata">CoreData</h2>

<p>对于<code>CoreData</code>，有很多相关的文章。推荐一个，<a href="https://www.objc.io/issues/4-core-data/core-data-overview/">Core Data Overview</a>，中文版<a href="http://objccn.io/issue-4-1/">Core Data 概述</a>。</p>

<h1 id="相关文章">相关文章</h1>
<hr />
<ul>
  <li><a href="http://www.jianshu.com/p/2944233ebac4">iOS沙盒机制介绍</a></li>
  <li><a href="http://www.jianshu.com/p/7616cbd72845">我要永远地记住你！（iOS中几种数据持久化方案）</a></li>
  <li><a href="http://www.appcoda.com/sqlite-database-ios-app-tutorial/">SQLite 3 Functions Preview</a></li>
</ul>

    </div>
    <div class="feat share">
      <a href="http://twitter.com/share" class="popup">
        <span class="icon-twitter"></span>
      </a>
    </div>
    
      <a rel="next" href="/hikari-for-jekyll/2018/01/14/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E7%AE%80%E4%BB%8B/" id="next">
        <span class="nav-title nav-title-next">newer</span> &rarr;
      </a>
    
    
      <a rel="prev" href="/hikari-for-jekyll/2016/01/12/%E6%B5%85%E8%B0%88NSString-copy%E4%B8%8Estrong%E7%9A%84%E5%8C%BA%E5%88%AB/" id="prev">
        &larr; <span class="nav-title nav-title-prev">older</span>
      </a>
    
  </article>
</section>

      </main>

      <footer>
        <small>Powered by Jekyll - Theme: <a href="https://github.com/m3xm/hikari-for-Jekyll">hikari</a> - &copy; John Doge</small>
      </footer>

    </div>
    

    <script src="/hikari-for-jekyll/js/main.js"></script>
    
    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-47727049-1', 'm3xm.github.io');
        ga('send', 'pageview');
      </script>
    

  </body>
</html>
